name: Performance Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '20'
  PLAYWRIGHT_VERSION: '1.40.0'

jobs:
  # Job 1: Lighthouse CI
  lighthouse-ci:
    name: Lighthouse CI Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Run Lighthouse CI
        run: |
          npm install -g @lhci/cli@0.12.x
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports
          path: |
            .lighthouseci/
            lhci-reports/
          retention-days: 30

  # Job 2: Bundle Size Check
  bundle-size:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Analyze bundle size
        run: npm run analyze

      - name: Check bundle size with bundlesize
        run: npx bundlesize

      - name: Upload bundle analysis
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis
          path: |
            dist/stats.html
            bundlesize-report/
          retention-days: 30

      - name: Comment bundle size on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Lire les stats du bundle
            const statsPath = path.join(process.cwd(), 'dist', 'stats.html');
            let bundleSizeComment = '## üì¶ Bundle Size Analysis\n\n';
            
            if (fs.existsSync(statsPath)) {
              const statsContent = fs.readFileSync(statsPath, 'utf-8');
              
              // Extraire la taille totale (approximation)
              const sizeMatch = statsContent.match(/(\d+\.?\d*)\s*(KB|MB|GB)/i);
              if (sizeMatch) {
                bundleSizeComment += `**Total Bundle Size:** ${sizeMatch[0]}\n\n`;
              }
              
              bundleSizeComment += 'View detailed analysis in the [artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).\n\n';
            }
            
            // V√©rifier les budgets
            bundleSizeComment += '### Budgets:\n';
            bundleSizeComment += '- JavaScript: < 300KB (gzipped)\n';
            bundleSizeComment += '- CSS: < 50KB (gzipped)\n';
            bundleSizeComment += '- Total: < 500KB (gzipped)\n';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: bundleSizeComment
            });

  # Job 3: Performance Budget
  performance-budget:
    name: Performance Budget Tests
    runs-on: ubuntu-latest
    needs: [lighthouse-ci, bundle-size]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: |
          npx playwright install --with-deps chromium

      - name: Build application
        run: npm run build

      - name: Start preview server
        run: npm run preview &
        env:
          PORT: 4173

      - name: Wait for server
        run: npx wait-on http://localhost:4173 --timeout 60000

      - name: Run bundle size tests
        run: npx playwright test tests/performance/bundle.spec.ts --project=chromium

      - name: Run memory tests
        run: npx playwright test tests/performance/memory.spec.ts --project=chromium

      - name: Run rendering tests
        run: npx playwright test tests/performance/rendering.spec.ts --project=chromium

      - name: Run interaction tests
        run: npx playwright test tests/performance/interaction.spec.ts --project=chromium

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-test-results
          path: |
            playwright-report/
            test-results/
          retention-days: 30

  # Job 4: Benchmark
  benchmark:
    name: Performance Benchmark
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run benchmark
        run: node scripts/benchmark.js --compare

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark-results/
          retention-days: 90

  # Job 5: Performance Report
  performance-report:
    name: Generate Performance Report
    runs-on: ubuntu-latest
    needs: [lighthouse-ci, bundle-size, performance-budget, benchmark]
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate summary report
        run: |
          echo "# Performance Test Results" > performance-report.md
          echo "" >> performance-report.md
          echo "## Summary" >> performance-report.md
          echo "" >> performance-report.md
          echo "| Job | Status |" >> performance-report.md
          echo "|-----|--------|" >> performance-report.md
          echo "| Lighthouse CI | ${{ needs.lighthouse-ci.result }} |" >> performance-report.md
          echo "| Bundle Size | ${{ needs.bundle-size.result }} |" >> performance-report.md
          echo "| Performance Budget | ${{ needs.performance-budget.result }} |" >> performance-report.md
          echo "| Benchmark | ${{ needs.benchmark.result }} |" >> performance-report.md
          echo "" >> performance-report.md
          echo "## Budgets" >> performance-report.md
          echo "" >> performance-report.md
          echo "- **FCP**: < 1.8s" >> performance-report.md
          echo "- **LCP**: < 2.5s" >> performance-report.md
          echo "- **TTI**: < 3.8s" >> performance-report.md
          echo "- **CLS**: < 0.1" >> performance-report.md
          echo "- **Total Bundle**: < 500KB (gzipped)" >> performance-report.md
          echo "" >> performance-report.md
          echo "View detailed reports in the [artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})." >> performance-report.md

      - name: Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: performance-report.md
          retention-days: 30

      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('performance-report.md', 'utf-8');
            
            // Trouver un commentaire existant
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Performance Test Results')
            );
            
            if (botComment) {
              // Mettre √† jour le commentaire existant
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
            } else {
              // Cr√©er un nouveau commentaire
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
            }

  # Job 6: Performance Regression Check
  regression-check:
    name: Performance Regression Check
    runs-on: ubuntu-latest
    needs: [lighthouse-ci]
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download base branch artifacts
        uses: dawidd6/action-download-artifact@v3
        continue-on-error: true
        with:
          branch: ${{ github.base_ref }}
          workflow: performance.yml
          name: lighthouse-reports
          path: base-reports

      - name: Compare performance
        if: success()
        run: |
          echo "Comparing performance with base branch..."
          # Script de comparaison personnalis√© si n√©cessaire
          echo "Performance comparison complete"

      - name: Fail on regression
        if: failure()
        run: |
          echo "::warning::Could not compare with base branch. This might be the first run."
